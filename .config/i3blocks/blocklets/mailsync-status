#!/bin/bash

info=""
exitcode=0

queuedir="${HOME}/.local/var/spool/msmtpqueue"
if find "${queuedir}" -name '*.msmtp' 2>/dev/null | read -r; then
    info="\uf10e"
fi

inbox="${HOME}/.maildir/new"
if [ "$(find "${inbox}" -type f 2>/dev/null | wc -l)" -gt 0 ]; then
    info="$info\uf105"
fi

rundir="${XDG_RUNTIME_DIR:-${HOME}/.local/var/run}/mailsync"
pidfile="${rundir}/PID"
otherpid=$(cat "${pidfile}" 2>/dev/null)
othercmd=$(ps --no-headers --format command --pid "${otherpid}" 2>/dev/null)
if [[ "${othercmd}" =~ .*mailsync.* ]]; then
    info="\uf021"
fi

if [ "$(find "${rundir}" -type f -name "*.error" 2>/dev/null | wc -l)" -gt 0 ]; then
    exitcode=33
fi

if [ -n "$info" ] || [ $exitcode -ne 0 ]; then
    echo -e "$info\uf132"
fi

exit "$exitcode"
