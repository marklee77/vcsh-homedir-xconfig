#!/bin/bash
thresholds=(15 40 95 100)
prefixes=("" "" "" "")
colors=("#FF0000" "#FFFF00" "#FFFFFF" "#00FF00")
charging_prefix=" "
charging_color="#00FF00"

warn_minutes=10
hibernate_minutes=5

battery=${1:-BAT0}

present_rate=$(perl -ane 'print "$F[2]\n" if (/^present rate:/);' /proc/acpi/battery/${battery}/state)
remaining_capacity=$(perl -ane 'print "$F[2]\n" if (/^remaining capacity:/);' /proc/acpi/battery/${battery}/state)
design_capacity=$(perl -ane 'print "$F[2]\n" if (/^design capacity:/);' /proc/acpi/battery/${battery}/info)

percentage="$((100*$remaining_capacity/$design_capacity))"
for i in $(seq 0 $((${#thresholds[@]}-1))); do
    if [ $percentage -le ${thresholds[i]} ]; then
        prefix=${prefixes[i]}
        color=${colors[i]}
        break
    fi
done

if on_ac_power || [ $present_rate -le 0 ]; then
    prefix=$charging_prefix
    color=$charging_color
else
    minutes_remaining=$(($remaining_capacity*60/$present_rate))
    hours_remaining=$(($minutes_remaining/60))
    minutes_remaining_partial=$(($minutes_remaining%60))
    if [ $minutes_remaining_partial -lt 10 ]; then
        minutes_remaining_partial="0$minutes_remaining_partial"
    fi
    time_remaining="$hours_remaining:$minutes_remaining_partial"

    #if [ ${BATTERY_STATUS} = "ok" ] &&
       #[ ${BATTERY_MINUTES_REMAINING} -lt ${BATTERY_WARN_MINUTES} ]; 
    #then

        #BATTERY_STATUS=low
        ##notify-send --urgency=critical \
        ##    "Low Battery Warning!" \
        ##    "The remaining battery charge is critically low. Please connect to AC power."

    #elif [ ${BATTERY_STATUS} = "low" ] &&
         #[ ${BATTERY_MINUTES_REMAINING} -lt ${BATTERY_HIBERNATE_MINUTES} ]; then

        #BATTERY_STATUS=critical

        ##notify-send --urgency=critical \
        ##    "Hibernating!" \
        ##    "If the computer is not plugged in within the next 30 seconds, hibernation procedures will commence."

        ##sleep 30

        ##if ! on_ac_power; then
        ##    laptop-hibernate
        ##fi

    #fi

fi

short_text="$prefix $percentage%"
full_text=$short_text
[ -n $time_remaining ] && full_text="$full_text $time_remaining"

echo $full_text
echo $short_text
[ -n "$color" ] && echo $color

exit 0
